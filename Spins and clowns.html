<!-- Wildcard animation element -->
<img id="wildAnimation" class="wild-animation" src="https://bashof.org/wp-content/uploads/2023/11/OJ_Simpson_1987-e1489501934717.jpg" style="display:none;"/>
<div id="wildText" style="position:absolute;color:yellow;font-size:24px;font-weight:bold;text-shadow:2px 2px 6px #000;display:none;z-index:9999;">SUPER RARE OJ WILDCARD APPEARED</div>
<div id="goldenLine" class="golden-line"></div>

<script>
let isJackpotPlaying = false;

function animateWild(x, y){
    wildAnimation.style.left = x + 'px';
    wildAnimation.style.top = '0px';
    wildAnimation.style.display = 'block';
    wildAnimation.style.transition = 'top 1s ease, transform 0.5s ease';
    
    wildText.style.left = x + 'px';
    wildText.style.top = (y + 120) + 'px';
    wildText.style.display = 'block';

    setTimeout(()=>{
        wildAnimation.style.top = y + 'px';
        wildAnimation.style.transform = 'rotate(10deg)';
    },50);

    setTimeout(()=>{
        wildAnimation.style.display = 'none';
        wildAnimation.style.transform = 'rotate(0deg)';
        wildText.style.display = 'none';
    },1200);
}

// Adjusted spin logic
function spin(){
    if(balance<=0){messageEl.textContent="AHAHAH CLOWN";return;}
    if(isSpinning) return;
    isSpinning = true;
    spinCount++;
    messageEl.textContent="Spinning...";

    if(!isJackpotPlaying && spinSound.paused) spinSound.play();

    const results=[];
    for(let r=0;r<3;r++){
        const start=Math.floor(Math.random()*reels[r].length);
        const strip=createReelStrip(reels[r],start);
        reelContainers[r].innerHTML='';
        reelContainers[r].appendChild(strip);
        setTimeout(()=>{strip.style.transform='translateY(-'+(strip.children.length-3)*360+'px)';},50);
        results.push([strip,start]);
    }

    setTimeout(()=>{
        let winAmount=0;
        let jackpotHit=false;

        // Jackpot every 5 spins
        if(spinCount%5===0){
            if(Math.random()<0.01){balance+=Math.round(balance*0.01);winAmount=Math.round(balance*0.01);}
            else{balance-=Math.round(balance*0.10);winAmount=-Math.round(balance*0.10);}
            jackpotHit=true;

            // Mute spin while jackpot plays
            spinSound.volume = 0;
            isJackpotPlaying = true;
            jackpotSound.src = jackpotFiles[Math.floor(Math.random()*jackpotFiles.length)];
            jackpotSound.volume = 0.5;
            jackpotSound.currentTime = 0;
            jackpotSound.play();
            jackpotSound.onended = ()=>{
                spinSound.volume = 1;
                isJackpotPlaying = false;
            };
        }

        // Check middle row for wins (realistic)
        let middleSymbols=[];
        for(let r=0;r<3;r++){middleSymbols.push(results[r][0].children[1].firstChild.src);}
        if(new Set(middleSymbols).size===1){winAmount=selectedBet*5;drawGoldenLine([reelContainers[0].getBoundingClientRect().top+180]);}

        // Wildcard animation
        if(Math.random()<0.25){
            animateWild(reelContainers[1].getBoundingClientRect().left+120, reelContainers[1].getBoundingClientRect().top+180);
        }

        balance += winAmount;
        document.getElementById('balanceDisplay').textContent = balance + " doubloon";

        const midCell = reelContainers[1].getBoundingClientRect();
        if(winAmount>0){
            winAmountEl.textContent = winAmount+" doubloon";
            winPopup.style.left=(midCell.left+midCell.width/2)+'px';
            winPopup.style.top=(midCell.top+midCell.height/2)+'px';
            winPopup.classList.add('show');
            winSound.currentTime=0;
            winSound.play();
            setTimeout(()=>winPopup.classList.remove('show'),1800);
        }

        if(jackpotHit){
            jackpotAmountEl.textContent = winAmount<0?`-${-winAmount}`:winAmount+" doubloon";
            jackpotPopup.style.left=(midCell.left+midCell.width/2)+'px';
            jackpotPopup.style.top=(midCell.top+midCell.height/2)+'px';
            jackpotPopup.classList.add('show');
            document.body.classList.add('bg-shake');
            setTimeout(()=>{jackpotPopup.classList.remove('show');document.body.classList.remove('bg-shake');},1800);
        }

        localStorage.setItem('balance',balance);
        isSpinning=false;
    },1600);
}
</script>
